<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tus Libros</title>

  <!-- Fonts to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <!-- Icons to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
  <div id="root"></div>

  <script src="./lib/react.development.js" crossorigin="anonymous"></script>
  <script src="./lib/react-dom.development.js" crossorigin="anonymous"></script>
  <script src="./lib/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="./lib/babel.min.js" crossorigin="anonymous"></script>
  <script src="./src/refreshbrowser.js" crossorigin="anonymous"></script>

  <!-- Libraries fallback -->
  <script>window.React || document.write('<script src="https://unpkg.com/react@16.11.0/umd/react.development.js">\x3C/script>')</script>
  <script>window.ReactDOM || document.write('<script src="https://unpkg.com/react-dom@16.11.0/umd/react-dom.development.js">\x3C/script>')</script>
  <script>window.MaterialUI || document.write('<script src="https://unpkg.com/@material-ui/core@4.6.1/umd/material-ui.development.js">\x3C/script>')</script>
  <script>window.Babel || document.write('<script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js">\x3C/script>')</script>
  <!-- end fallback -->

  <script type="text/babel" type="module">
    const {
      AppBar,
      Avatar,
      Button,
      colors,
      CircularProgress,
      Checkbox,
      Container,
      createMuiTheme,
      CssBaseline,
      Icon,
      IconButton,
      InputAdornment,
      InputLabel,
      FormControl,
      Link,
      List,
      ListItem,
      ListItemIcon,
      ListItemText,
      ListItemAvatar,
      ListItemSecondaryAction,
      makeStyles,
      OutlinedInput,
      TextField,
      ThemeProvider,
      Toolbar,
      Typography,
      Dialog,
      DialogActions,
      DialogContent,
      DialogContentText,
      DialogTitle
    } = MaterialUI;
    const theme = createMuiTheme({
      palette: {
        primary: {
          main: '#556cd6',
        },
        secondary: {
          main: '#19857b',
        },
        error: {
          main: colors.red.A400,
        },
        background: {
          default: '#fff',
          paper: '#f5f5f5',
        },
      },
    });
    const useStyles = makeStyles(theme => ({
      list: {
        margin: theme.spacing(0, 0, 0, 0),
      },
      login: {
        height: "60vh",
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
      },
      root: {
        margin: theme.spacing(6, 0, 3),
      },
      lightBulb: {
        verticalAlign: 'middle',
        // marginRight: theme.spacing(1),
      },
      rootToolBar: {
        flexGrow: 1,
      },
      menuButton: {
        marginRight: theme.spacing(2),
      },
      textField: {
            marginTop: theme.spacing(1),
            marginBottom: theme.spacing(1),
            width: '100%',
            textAlign: 'center',
      },
      title: {
        flexGrow: 1,
      },
      rootList: {
        width: '100%',
        backgroundColor: theme.palette.background.paper,
        position: 'relative',
        overflow: 'auto',
        maxHeight: 300,
      },
      textFieldDetails: {
        margin: theme.spacing(2),
      }
    }));

    const getLocalAsJson = (path) => {
      var port = 8082
    
      return fetch(`http://localhost:${port}/${path}`, {
        method: "GET",
        dataType: "JSON",
        headers: {
          "Access-Control-Request-Headers": "*"
        }
      })
    }
    
    const getISBNApiAsJson = (isbn) => {
      return fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`, {
        method: "GET",
        dataType: "JSON",
        headers: {
          "Access-Control-Request-Headers": "*"
        }
      })
    }
    
    const listPurchases = (userID, password, handleResponse) => {
      getLocalAsJson(`listPurchases?userID=${userID}&password=${password}`)
        .then(function (response) {
          return response.json()
        })
        .then(handleResponse)
        .catch(function (error) {
          console.log('Looks like there was a problem: \n', error);
        });
    }
    
    const modifyCart = (action, cartID, isbn, handleResponse, onFailureDo) => {
      getLocalAsJson(`${action}?quantity=1&isbn=${isbn}&cartID=${cartID}`)
        .then(function (response) {
          return response.json()
        })
        .then(handleResponse)
        .catch(function (error) {
          console.log('Looks like there was a problem: \n', error);
          onFailureDo()
        });
    }
    
    const addToCart = (cartID, isbn, handleResponse, onFailureDo) => {
      modifyCart('addToCart', cartID, isbn, handleResponse, onFailureDo)
    }
    
    const removeFromCart = (cartID, isbn, handleResponse, onFailureDo) => {
      modifyCart('removeFromCart', cartID, isbn, handleResponse, onFailureDo)
    }

        function MyToolBar(props) {
          const classes = useStyles();
          const {title, router} = props;
        
          let menuButton = (
            <IconButton
              edge="start"
              className={classes.menuButton}
              color="inherit"
              onClick={()=> {
                router.emptyCart()
                router.navigate("/", {
                substrings: [],
                selectedSubstring: "",})
                }
              }
              >
              <Icon>close</Icon>
            </IconButton>
          )
    
          let carritoButton = (
            <IconButton
              edge="start"
              className={classes.menuButton}
              color="inherit"
              onClick={()=>router.navigate("/cart", {
                substrings: [],
                selectedSubstring: "",})}
              >
              <Icon>shopping_cart</Icon>
            </IconButton>
          )
    
          let catalogButton = (
            <IconButton
              edge="start"
              className={classes.menuButton}
              color="inherit"
              onClick={()=>router.navigate("/catalog", {
                substrings: [],
                selectedSubstring: "",})}
              >
              <Icon>list</Icon>
            </IconButton>
          )
    
          let purchasesButton = (
            <IconButton
              edge="start"
              className={classes.menuButton}
              color="inherit"
              onClick={()=>router.navigate("/listPurchases", {
                substrings: [],
                selectedSubstring: "",})}
              >
              <Icon>account_circle</Icon>
            </IconButton>
          )
    
          if (router.current() === "/") {
    
            menuButton = (<div></div>)
            carritoButton = (<div></div>)
            purchasesButton = (<div></div>)
            catalogButton = (<div></div>)
          }
        
          return (
            <div className={classes.rootToolBar}>
              <AppBar position="static">
                <Toolbar>
                  {menuButton}
                  {catalogButton}
                  {carritoButton}
                  {purchasesButton}
                  <Typography variant="h6" className={classes.title}>
                    {title}
                  </Typography>
                  {/*<Button color="inherit">Login</Button>*/}
                </Toolbar>
              </AppBar>
            </div>
          )
        }
    
    function LoginView(props) {
      const { router, carrito } = props
      const classes = useStyles();
      const [userCredentials, setUserCredentials] = React.useState({
        userID: '',
        password: ''
      });
    
      const [dialog, setDialog] = React.useState({ open: false, message: '' });
    
      const closeDialog = () => {
        setDialog({ open: false, message: '' });
      };
    
      const handleChange = prop => event => {
        setUserCredentials({ ...userCredentials, [prop]: event.target.value });
      };
    
      const login = (userID, password) => {
        loading = true;
        getLocalAsJson(`createCart?userID=${userID}&password=${password}`)
          .then(function (response) {
            loading = false;
            console.log(response)
            if (response.ok) return response.json()
    
            response.json().then(data => { setDialog({ open: true, message: data.message }) });
            throw new Error('Login Failed')
          })
          .then(function (json) {
            loading = false;
            router.setUserCredentials(userID, password)
            router.navigate("/catalog", { carrito: { ...carrito, cartID: json.cartID } })
          })
          .catch(function (error) {
            loading = false;
            console.log('Looks like there was a problem: \n', error);
          });
      }
      var loading = false;
    
      return (
        <div>
              <FormControl fullWidth className={classes.login} variant="outlined">
                        <Typography component="h1" gutterBottom style={{textAlignVertical: "center",textAlign: "center",}}>
                Ingrese su usuario y contrase√±a
                  </Typography>
                <div>
                <TextField 
                  id="outlined-adornment-amount"
                  value={userCredentials.userID}
                  onChange={handleChange('userID')}
                  className={classes.textField}
                  label="User"
                  autoComplete="off"
                />
                </div>
                <div>
                
              <TextField 
                id="standard-password-input"
                value={userCredentials.password}
                onChange={handleChange('password')}
                label="Password"
                className={classes.textField}
                type="password"
                autoComplete="current-password"
                />
              </div>
    
                          <div>
        
              <Button 
              color="primary" 
                 className={classes.button}
                onClick={() => login(userCredentials.userID, userCredentials.password)}>
                Ingresar
                  </Button>
              </div>
              <div> </div>
              {loading ? <div style={{display: 'flex', justifyContent: 'center'}}>
              <CircularProgress />
    </div> : <div> </div> }
              </FormControl>
    
    
              <Dialog
                open={dialog.open}
                keepMounted
                style={{backgroundColor: 'red'}}
                onClose={closeDialog}
                aria-labelledby="alert-dialog-slide-title"
                aria-describedby="alert-dialog-slide-description"
              >
                <DialogTitle id="alert-dialog-slide-title">{"Login Failed"}</DialogTitle>
                <DialogContent>
                  <DialogContentText id="alert-dialog-slide-description">
                    {dialog.message}
                  </DialogContentText>
                </DialogContent>
                <DialogActions>
                  <Button onClick={closeDialog} color="primary">
                    Ok
                  </Button>
                </DialogActions>
              </Dialog>
        
        </div>
      )
    }
    function CatalogView(props) {
      const { router, catalog, carrito } = props
      const classes = useStyles();
    
      console.log('Cart ID:', carrito.cartID)
    
      const navigateTo = bookIsbn => () => {
        router.navigate("/book", { bookIsbn: bookIsbn })
      };
    
      console.log('Catalgo:', catalog)
    
      return (
        <div>
        <List dense className={classes.list}>
          {Object.keys(catalog).map(bookIsbn => {
            const labelId = `checkbox-list-secondary-label-${bookIsbn}`;
            return (
              <ListItem key={bookIsbn} button onClick={navigateTo(bookIsbn)}>
                <ListItemAvatar>
                  <Avatar
                    variant="rounded" className={classes.rounded}
                    src={catalog[bookIsbn].cover.small}
                  />
                </ListItemAvatar>
                <ListItemText id={labelId} primary={catalog[bookIsbn].title} secondary={catalog[bookIsbn].price} />
                <ListItemSecondaryAction>
                  <QuantityButtons
                    bookIsbn={bookIsbn}
                    router={router}
                    catalog={catalog}
                    carrito={carrito}
                  />
                </ListItemSecondaryAction>
              </ListItem>
            );
          })}
        </List>
        </div>
      )
    }
    // Component
    function CarritoView(props) {
      const { router, reducedCatalog } = props
      const classes = useStyles();
    
      return (
        <div>
          <Button variant="contained" color="primary" className={classes.button} disabled = {reducedCatalog.length <= 0}>
            Check out
          </Button>
    
        </div>
      )
    }
    
    function BookView(props) {
      const { router, bookIsbn, catalog, carrito } = props
    
      const book = catalog[bookIsbn]
    
      return (
        <div>
           <img src={book.cover.medium} style={{float: 'left', padding: '20px'}}></img>
           <div style={{padding: '35px'}}>
           <Typography component="h1"><b>Title:</b> {book.title} </Typography> <br></br>
           <Typography component="h1"><b>Author:</b> {book.authors[0].name} </Typography> <br></br><br></br>
           <Typography component="h2"><b>Publisher:</b> {book.publishers[0].name} </Typography> <br></br>
           <Typography component="h2"><b>Publish date:</b> {book.publish_date} </Typography> <br></br>
           <Typography component="h2"><b>Number of pages:</b> {book.number_of_pages} </Typography> <br></br>
           <Typography component="h2"><b>Price:</b> {book.price} </Typography>
    
           <QuantityButtons
              bookIsbn={bookIsbn}
              router={router}
              catalog={catalog}
              carrito={carrito}
            />
           </div>
        </div>
      )
    }
    function QuantityButtons(props) {
      const { bookIsbn, router, catalog, carrito } = props
      const classes = useStyles();
    
      const [itemsCount, setItemsCount] = React.useState(carrito.items);
    
      const modifyItemCount = (bookIsbn, quantity) => {
        const newCount = {...itemsCount};
        newCount[bookIsbn].quantity = itemsCount[bookIsbn].quantity + quantity;
        setItemsCount(newCount)
        router.setCart({ items: newCount, cartID: carrito.cartID })
      };
    
      const handleInvalidResponse = () => {
        router.emptyCart()
        router.navigate("/", {})
      };
    
      const incrementCount = bookIsbn => () => {
        addToCart(carrito.cartID, bookIsbn, (data) => {
          modifyItemCount(bookIsbn, 1)
        }, handleInvalidResponse)
      };
      
      const decrementCount = bookIsbn => () => {
        removeFromCart(carrito.cartID, bookIsbn, (data) => {
          modifyItemCount(bookIsbn, -1)
        }, handleInvalidResponse)
      };
    
      return (
        <div>
        <IconButton className={classes.button} aria-label="add" style={{flex: 1}} edge="start" 
        onClick={incrementCount(bookIsbn)}>
        <Icon>add</Icon>
        </IconButton>
        <Typography component="h1"style= {{display:'inline-block'}}>{itemsCount[bookIsbn].quantity} </Typography>
        <IconButton className={classes.button} aria-label="remove" style={{flex: 1}}
        onClick={decrementCount(bookIsbn)} disabled={itemsCount[bookIsbn].quantity <= 0}>
        <Icon>remove</Icon>
        </IconButton>
        </div>
      )
    }
    
    class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          path: "/",
    <<<<<<< HEAD
          catalog: new Array(),
          carrito: { items: new Array(), cartID: 0 },
          bookIndex: 0,
          userCredentials: {userID: '', password: ''},
          purchases: { items: [], total_amount: 0 }
    =======
          catalog: {},
          carrito: { items: {}, cartID: 0 },
          emptyCarrito: { items: {}, cartID: 0 },
          bookIsbn: 0,
    >>>>>>> 0e40140ec4a2ce0f7f1fd88f3f73aa6facf66d75
        };
      }
    
      componentWillMount() {
        this.getCatalog();
      }
    
      getCatalog(){
        var self = this;
        getLocalAsJson(`getCatalog`)
          .then(response => {
            if (response.ok) return response.json()
            throw Error('Oops')
          })
          .then(data => {
              data.forEach( function(value, index, array) {
                self.handleBook(value)
            });
          })
          .catch(error => console.log(error.message))
      }
    
      handleBook = data => {
        var self = this;
        getISBNApiAsJson(data.isbn)
          .then(function (response) {
            return response.json()
          })
          .then(function (json) {
            var newCatalog = {...self.state.catalog}
            var book = json[Object.keys(json)[0]]
            book["price"] = '$' + data.price
            book["isbn"] = data.isbn
            newCatalog[data.isbn] = book
    
            var newCarrito = {...self.state.carrito}
            newCarrito.items[data.isbn] = { isbn: data.isbn, quantity: 0 }
            self.setState({ ...self.state, catalog: newCatalog, carrito: newCarrito, emptyCarrito: newCarrito })
          })
          .catch(function (error) {
            console.log('Looks like there was a problem: \n', error);
          });
      }
    
      getPurchases(){
        var self = this;
        listPurchases(this.state.userCredentials.userID, this.state.userCredentials.password, 
                         (data) => {
                          self.setState({ ...self.state, purchases: data})
        })
      }
    
      render() {
        let title = "Tus Libros"
        let content = "Where am I?"
        const router = {
          current: () => this.state.path,
          navigate: (path, state) => {
            this.setState({ ...state, path: path })
          },
          setCart: (carrito) => {
            this.setState({ ...this.state, carrito: carrito })
          },
          emptyCart: () => {
    <<<<<<< HEAD
            const emptyItems = this.state.carrito.items.map(item => { return {isbn: item.isbn, quantity: 0} })
            this.setState({ ...this.state, carrito: { items: emptyItems, cartID: 0 }})
          }, 
    
          setUserCredentials: (userID, password) => {
            this.setState({ ...this.state, userCredentials: {userID: userID, password: password} })
    =======
            this.setState({ ...this.state, carrito: this.state.emptyCarrito })
    >>>>>>> 0e40140ec4a2ce0f7f1fd88f3f73aa6facf66d75
          }
        }
    
        if (this.state.path === "/") {
          content = (<LoginView
            router={router}
            carrito={this.state.carrito}
          />)
        } else if (this.state.path === "/catalog") {
          content = (<CatalogView
            router={router}
            catalog={this.state.catalog}
            carrito={this.state.carrito}
          />)
        } else if (this.state.path === "/cart") {
          const reducedCatalog = {...this.state.catalog}
          Object.keys(this.state.catalog).forEach(isbn => {
            if (this.state.carrito.items[isbn].quantity == 0) delete reducedCatalog[isbn]
          })
          content = ( <div>
          <CatalogView
            router={router}
            catalog={reducedCatalog}
            carrito={this.state.carrito}
          />
          <CarritoView
          router={router}
          reducedCatalog={reducedCatalog} />
          </div>
          )
        } else if (this.state.path === "/book") {
          content = (
          <BookView
            router={router}
            bookIsbn={this.state.bookIsbn}
            catalog={this.state.catalog}
            carrito={this.state.carrito}
          />
          )
        } else if (this.state.path === "/listPurchases") {
          this.getPurchases()
          content = (<CatalogView
            router={router}
            catalog={this.state.purchases}
            carrito={this.state.carrito}
          />)
        }
        return (
          <div>
            <MyToolBar
              title={title}
              router={router}
            />
            <Container maxWidth="md">
              <div style={{ marginTop: 20, }}>
                {content}
              </div>
            </Container>
          </div>
        );
      }
    }

    ///////////////////////////////////////////////////////////////////////////
    // Initial render
    //
    ReactDOM.render(
      <ThemeProvider theme={theme}>
        <CssBaseline />
        <App />
      </ThemeProvider>,
      document.getElementById('root')
    )
  </script>

  <!-- <button onclick="window.location.reload(true)">reload</button> -->
</body>

</html>
